<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- 클래스 -->
    <script>
        class Member {
            constructor(name) {
                this.name = name;
                this.money = 10000;
            }

            restart() {
                return this.money += 10000;
            }

            addChange(money) {
                this.money += money;
            }
        }

        class Product {
            constructor(name, price, stock_quantity) {
                this.name = name;
                this.price = price;
                this.stock_quantity = stock_quantity;
            }

            isSoldOut() {
                return this.stock_quantity == 0;
            }

            removeStock() {
                return this.stock_quantity--;
            }
        }

        class VendingMachine {
            constructor(money, change, products) {
                this.money = 0;
                this.change = 0;
                this.products = [];
            }

            addProduct(product) {
                for (const existProduct of machine.products) {
                    if (existProduct.name == product.name) {
                        alert("이미 존재하는 상품입니다.");
                        return false;
                    }
                }
                this.products.push(product);
                return true;
            }

            calculate(member, product, money) {
                //잔고 부족
                if (member.money < money) {
                    document.getElementById('money').value = 0
                    alert("투입 금액보다 잔고가 부족합니다.");
                    return false;
                }

                //천원 단위만 가능
                if (money % 1000 != 0) {
                    document.getElementById('money').value = 0
                    alert("천원 단위만 투입 가능합니다.");
                    return false;
                }

                member.money -= money;
                this.money = money;

                //재고 부족으로 구매 불가능
                if (product.isSoldOut()) {
                    this.change += this.money;
                    alert("재고 부족으로 상품을 구매할 수 없습니다.");
                    return false;
                }

                //잔고 부족으로 상품 구매 불가
                if (money + this.change < product.price) {
                    this.change += this.money;
                    alert("상품 가격보다 금액이 부족합니다.");
                    return false;
                }

                //구매 시
                this.money -= (product.price - this.change);
                this.change = this.money;

                product.removeStock();

                return true;

            }

            returnChange(member) {
                member.addChange(this.change);
                this.change = 0;
            }
        }
    </script>

    <!-- 버튼 -->
    <script>
        //전역 변수
        let members = [];
        members.push(new Member("유사원"));
        members.push(new Member("이대리"));
        members.push(new Member("김과장"));
        members.push(new Member("박차장"));

        let machine = new VendingMachine();

        let member_record = new Map();
        let product_record = new Map();
        let machine_history = [];

        function addProduct() {
            let product_name = document.getElementById("product_name").value;
            let product_price = document.getElementById("product_price").value;
            let product_stock = document.getElementById("product_stock").value;

            if (product_name == "" || product_price == "" || product_stock == "") {
                alert("상품 정보를 입력해주세요.");
                return;
            }

            if (!product_price.match(/[0-9]/g)) {
                alert("가격은 숫자를 입력해주세요.");
                return;
            }

            if (!product_stock.match(/[0-9]/g)) {
                alert("재고는 숫자를 입력해주세요.");
                return;
            }

            let product = new Product(product_name, product_price, product_stock);

            if (machine.addProduct(product)) {

                const option = document.createElement("option");

                option.setAttribute('id', product_name);

                let textNode = document.createTextNode(product.name);
                option.appendChild(textNode);

                document.getElementById("machine").appendChild(option);

                changeProduct();

                document.getElementById("product_name").value = "";
                document.getElementById("product_price").value = "";
                document.getElementById("product_stock").value = "";
            }
        }

        function changeMember() {
            let index = document.getElementById('members').selectedIndex;
            let member = members[index];
            document.getElementById("member_name").value = member.name;
            document.getElementById("member_money").value = member.money;
        }

        function changeProduct() {
            document.getElementById("sold_out").innerHTML = "";

            let index = document.getElementById('machine').selectedIndex;
            let selectedProduct = machine.products[index];
            document.getElementById("machine_product_name").value = selectedProduct.name;
            document.getElementById("machine_product_price").value = selectedProduct.price;
            document.getElementById("machine_product_stock").value = selectedProduct.stock_quantity;

            if (selectedProduct.stock_quantity == 0) {
                document.getElementById("sold_out").innerHTML = "SOLD OUT";
            }
        }

        function restart() {
            for (const member of members) {
                member.restart();
            }
            changeMember();
        }

        function calculate() {
            let member_index = document.getElementById('members').selectedIndex;
            let product_index = document.getElementById('machine').selectedIndex;

            let member = members[member_index];
            let product = machine.products[product_index];

            let money = parseInt(document.getElementById('money').value);

            if (machine.calculate(member, product, money)) {

                //이용자 순위
                if (!member_record.has(member.name)) {
                    member_record.set(member.name, 1);
                } else {
                    let newVar = member_record.get(member.name);
                    member_record.set(member.name, newVar + 1);
                }
                //상품 순위
                if (!product_record.has(product.name)) {
                    product_record.set(product.name, 1);
                } else {
                    let newVar = product_record.get(product.name);
                    product_record.set(product.name, newVar + 1);
                }
                //자판기 이용 내역
                machine_history.push({"이용자" : member.name, "상품명" : product.name, "가격" : product.price, "시간" : new Date()})
            }

            changeMember();
            changeProduct();

            document.getElementById('money').value = 0;
            document.getElementById('change').value = machine.change;

        }

        function returnChange() {
            let index = document.getElementById('members').selectedIndex;
            let member = members[index];

            machine.returnChange(member);

            changeMember();

            document.getElementById('change').value = machine.change;
        }

        function total() {
            //자식 노드 삭제
            const cell = document.getElementById('total');
            while ( cell.hasChildNodes() ) {
                cell.removeChild( cell.firstChild );
            }

            //거래 목록 추가
            let table = document.createElement('table');

            //thead 추가
            let thead = document.createElement('thead');

            let row_1 = document.createElement('tr');
            let heading_1 = document.createElement('th');
            heading_1.innerHTML = "이름";
            let heading_2 = document.createElement('th');
            heading_2.innerHTML = "상품명";
            let heading_3 = document.createElement('th');
            heading_3.innerHTML = "가격";
            let heading_4 = document.createElement('th');
            heading_4.innerHTML = "시간";

            row_1.appendChild(heading_1);
            row_1.appendChild(heading_2);
            row_1.appendChild(heading_3);
            row_1.appendChild(heading_4);
            thead.appendChild(row_1);
            table.appendChild(thead);

            for (let i = 0; i < machine_history.length; i++) {
                //tbody 추가
                let tbody = document.createElement('tbody');

                let row_2 = document.createElement('tr');
                let row_2_data_1 = document.createElement('td');
                row_2_data_1.innerHTML = machine_history[i]['이용자'];
                let row_2_data_2 = document.createElement('td');
                row_2_data_2.innerHTML = machine_history[i]['상품명'];
                let row_2_data_3 = document.createElement('td');
                row_2_data_3.innerHTML = machine_history[i]['가격'];
                let row_2_data_4 = document.createElement('td');
                row_2_data_4.innerHTML = machine_history[i]['시간'];

                row_2.appendChild(row_2_data_1);
                row_2.appendChild(row_2_data_2);
                row_2.appendChild(row_2_data_3);
                row_2.appendChild(row_2_data_4);
                tbody.appendChild(row_2);
                table.appendChild(tbody);
            }
            document.getElementById('total').appendChild(table);

            //멤버 순위
            const memberRankSort = new Map([...member_record.entries()].sort((a, b) => b[1] - a[1]));

            let ul = document.createElement('ul');
            for (const key of memberRankSort.keys()) {
                let li = document.createElement('li');
                li.innerHTML = key + "[" + memberRankSort.get(key) + "]";
                ul.appendChild(li);
            }
            document.getElementById('total').appendChild(ul);

            //상품 순위
            const productRankSort = new Map([...product_record.entries()].sort((a, b) => b[1] - a[1]));

            let ol = document.createElement('ol');
            let rank = 1;
            let isKey;
            for (const key of productRankSort.keys()) {
                let li = document.createElement('li');
                if (rank == 1) {
                    li.innerHTML = key + "[" + productRankSort.get(key) + "] - 베스트 상품";

                    machine.products.find(
                        isKey = function (element) {
                            if (element.name === key) {
                                element.price = parseInt(element.price) + 100;
                                return true;
                            }
                        }
                    );
                } else {
                    li.innerHTML = key + "[" + productRankSort.get(key) + "]";
                }
                rank++;
                ol.appendChild(li);
            }
            document.getElementById('total').appendChild(ol);

            changeMember();
            changeProduct();

            //통계 초기화
            member_record = new Map();
            product_record = new Map();
            machine_history = [];
        }


    </script>

    <!-- 로딩 시점 (초기 데이터) -->
    <script>
        window.onload = function() {
            for (let i = 0; i < members.length; i++) {

                const option = document.createElement("option");

                option.setAttribute('id', members[i].name);
                option.setAttribute('value', members[i].money);

                let textNode = document.createTextNode(members[i].name);
                option.appendChild(textNode);

                document.getElementById("members").appendChild(option);
            }

            document.getElementById("member_name").value = members[0].name;
            document.getElementById("member_money").value = members[0].money;
        }
    </script>
</head>
<body>
    <h1>코딩 테스트 과제 - 자판기</h1>

    <h2>사장 (나사장)</h2>
    <p>1. 상품 추가</p>
    <label for="product_name">이름 :</label>
    <input type="text" id="product_name" placeholder="상품명">
    <label for="product_price">가격 :</label>
    <input type="text" id="product_price" placeholder="상품 가격">
    <label for="product_stock">재고 :</label>
    <input type="text" id="product_stock" placeholder="상품 수량">
    <br/>
    <button onclick="addProduct()">상품 추가</button>

    <p>2. 정산</p>
    <button onclick="total()">정산하기</button>

    <div id="total"></div>

    <h2>사용자</h2>
    <select id="members" onchange="changeMember()">
    </select>

    <h4>사용자 정보</h4>
    <label for="member_name">이름 :</label>
    <input type="text" id="member_name" value="" readonly>
    <label for="member_money">지갑 :</label>
    <input type="text" id="member_money" value="" readonly>
    <br/>

    <button onclick="restart()">재시작</button>

    <h2>자판기</h2>
    <select id="machine" onchange="changeProduct()">
    </select>

    <h4>상품 정보</h4>
    <label for="machine_product_name">이름 :</label>
    <input type="text" id="machine_product_name" value="" readonly>
    <label for="machine_product_price">가격 :</label>
    <input type="text" id="machine_product_price" value="" readonly>
    <label for="machine_product_stock">재고 :</label>
    <input type="text" id="machine_product_stock" value="" readonly>
    <p id="sold_out"></p>

    <h4>투입 금액</h4>
    <input type="text" id="money" value="0">

    <h4>잔돈</h4>
    <input type="text" id="change" value="0" readonly>
    <br/>

    <button onclick="calculate()">계산하기</button>
    <button onclick="returnChange()">반환하기</button>

</body>
</html>